# Buck2 SQLite xShmMap é”™è¯¯ä¸ Copy-up çš„å…³ç³»

## ğŸ¯ é—®é¢˜ï¼šSQLite xShmMap é”™è¯¯æ˜¯ä»€ä¹ˆï¼Ÿ

### å®Œæ•´é”™è¯¯ä¿¡æ¯

```
Error: I/O error within the xShmMap method
```

è¿™ä¸ªé”™è¯¯æ¥è‡ª SQLite çš„ WAL (Write-Ahead Logging) æ¨¡å¼ã€‚

## ğŸ“– SQLite WAL æ¨¡å¼ç®€ä»‹

### ä»€ä¹ˆæ˜¯ WALï¼Ÿ

WAL (Write-Ahead Logging) æ˜¯ SQLite çš„ä¸€ç§æ—¥å¿—æ¨¡å¼ï¼š

```
ä¼ ç»Ÿæ¨¡å¼:
  database.db  (å•æ–‡ä»¶)

WAL æ¨¡å¼:
  database.db       (ä¸»æ•°æ®åº“æ–‡ä»¶)
  database.db-wal   (Write-Ahead Log æ–‡ä»¶)
  database.db-shm   (å…±äº«å†…å­˜æ–‡ä»¶) â† xShmMap æ“ä½œçš„æ–‡ä»¶
```

### xShmMap æ˜¯ä»€ä¹ˆï¼Ÿ

`xShmMap` æ˜¯ SQLite VFS (Virtual File System) æ¥å£çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºï¼š
- åˆ›å»ºå’Œæ˜ å°„**å…±äº«å†…å­˜æ–‡ä»¶** (`database.db-shm`)
- å…è®¸å¤šä¸ªè¿›ç¨‹/è¿æ¥å…±äº« WAL ç´¢å¼•
- æé«˜å¹¶å‘æ€§èƒ½

### è°ƒç”¨æµç¨‹

```c
// SQLite å†…éƒ¨è°ƒç”¨é“¾
sqlite3_open()
  â†’ åˆå§‹åŒ– WAL æ¨¡å¼
  â†’ åˆ›å»º .db-shm æ–‡ä»¶
  â†’ xShmMap() æ˜ å°„å…±äº«å†…å­˜
     â†’ open() ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–‡ä»¶
        â†’ åœ¨ FUSE ä¸Šè§¦å‘æ–‡ä»¶åˆ›å»º
           â†’ è§¦å‘ OverlayFS copy-up
```

## ğŸ”— ä¸ Copy-up çš„å…³ç³»

### å®Œæ•´çš„è°ƒç”¨é“¾

```
Buck2 å¯åŠ¨
  â†“
åˆå§‹åŒ–çŠ¶æ€ç®¡ç†ï¼ˆdaemon stateï¼‰
  â†“
åˆ›å»º SQLite æ•°æ®åº“
  â†“
å¯ç”¨ WAL æ¨¡å¼
  â†“
SQLite å°è¯•åˆ›å»º .db-shm æ–‡ä»¶
  â†“
åœ¨ Antares æŒ‚è½½ç‚¹åˆ›å»ºæ–‡ä»¶
  â†“
OverlayFS æ”¶åˆ° FUSE_CREATE è¯·æ±‚
  â†“
æ£€æŸ¥ï¼šæ–‡ä»¶åœ¨å“ªä¸ªå±‚ï¼Ÿ
  â”œâ”€ å¦‚æœåœ¨ upper layer â†’ ç›´æ¥åˆ›å»ºï¼ˆæˆåŠŸï¼‰
  â””â”€ å¦‚æœåœ¨ lower layer æˆ–ä¸å­˜åœ¨ â†’ éœ€è¦ copy-up
     â†“
     OverlayFS::copy_regfile_up()
       â†“
       è°ƒç”¨ lower_layer.do_getattr_helper(inode, None)  (0.1.8)
       æˆ– lower_layer.getattr_with_mapping(inode, None, false) (0.1.9)
         â†“
         Dicfuse::do_getattr_helper / getattr_with_mapping
           â”œâ”€ âœ… å·²å®ç° â†’ è¿”å› stat â†’ copy-up æˆåŠŸ â†’ æ–‡ä»¶åˆ›å»ºæˆåŠŸ
           â””â”€ âŒ æœªå®ç° â†’ è¿”å› ENOSYS â†’ copy-up å¤±è´¥ â†’ æ–‡ä»¶åˆ›å»ºå¤±è´¥
                                                         â†“
                                                  xShmMap() å¤±è´¥
                                                         â†“
                                                  WAL åˆå§‹åŒ–å¤±è´¥
                                                         â†“
                                                  SQLite æŠ¥é”™: xShmMap I/O error
                                                         â†“
                                                  Buck2 åˆå§‹åŒ–å¤±è´¥
```

## ğŸ’¡ ä¸ºä»€ä¹ˆé”™è¯¯ä¿¡æ¯æ˜¯ "xShmMap"ï¼Ÿ

### é”™è¯¯çš„ä¼ æ’­è·¯å¾„

```
åº•å±‚é”™è¯¯:
  OverlayFS copy-up å¤±è´¥
  â†’ è¿”å› ENOSYS ç»™ FUSE å†…æ ¸
  â†’ FUSE å†…æ ¸è¿”å› EIO æˆ– ENOSYS ç»™åº”ç”¨
  â†’ open() ç³»ç»Ÿè°ƒç”¨å¤±è´¥

SQLite çš„å¤„ç†:
  open() å¤±è´¥
  â†’ xShmMap() å†…éƒ¨æ•è·é”™è¯¯
  â†’ åŒ…è£…æˆ "xShmMap I/O error"
  â†’ æŠ¥å‘Šç»™ä¸Šå±‚ï¼ˆBuck2ï¼‰

Buck2 çœ‹åˆ°çš„:
  "Error: I/O error within the xShmMap method"
```

### ä¸ºä»€ä¹ˆé”™è¯¯ä¿¡æ¯æœ‰è¯¯å¯¼æ€§ï¼Ÿ

```
çœŸå®é—®é¢˜å±‚çº§:

Layer 5 (ç”¨æˆ·è§†è§’):   Buck2 SQLite xShmMap error
                      â†‘
Layer 4 (SQLite):     xShmMap() è°ƒç”¨å¤±è´¥
                      â†‘
Layer 3 (FUSE):       æ–‡ä»¶åˆ›å»ºå¤±è´¥
                      â†‘
Layer 2 (OverlayFS):  Copy-up å¤±è´¥
                      â†‘
Layer 1 (Dicfuse):    do_getattr_helper è¿”å› ENOSYS  â† çœŸæ­£çš„æ ¹å› ï¼
```

**é—®é¢˜**: ç”¨æˆ·åªèƒ½çœ‹åˆ° Layer 5 çš„é”™è¯¯ä¿¡æ¯ï¼ˆxShmMapï¼‰ï¼Œä½†çœŸæ­£çš„æ ¹å› åœ¨ Layer 1ï¼

## ğŸ” è¯¦ç»†çš„ Copy-up è¿‡ç¨‹

### ä»€ä¹ˆæ˜¯ Copy-upï¼Ÿ

Copy-up æ˜¯ OverlayFS çš„æ ¸å¿ƒæœºåˆ¶ï¼š

```
OverlayFS ç»“æ„:

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Upper Layer    â”‚  (å¯å†™å±‚ï¼Œå¦‚ PassthroughFS)
  â”‚  (ç©ºçš„æˆ–æœ‰ä¿®æ”¹)  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘ copy-up
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Lower Layer    â”‚  (åªè¯»å±‚ï¼Œå¦‚ Dicfuse)
  â”‚  (åŸå§‹æ–‡ä»¶)      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Copy-up çš„è§¦å‘æ¡ä»¶

å½“ç”¨æˆ·å°è¯•**ä¿®æ”¹**æˆ–**åˆ›å»º**æ–‡ä»¶æ—¶ï¼š

1. **ä¿®æ”¹å·²å­˜åœ¨çš„æ–‡ä»¶**:
   ```
   ç”¨æˆ·: echo "new" >> existing_file.txt
   â†’ æ–‡ä»¶åœ¨ lower layerï¼ˆåªè¯»ï¼‰
   â†’ è§¦å‘ copy-up
   â†’ å°†æ–‡ä»¶å¤åˆ¶åˆ° upper layer
   â†’ ç„¶ååœ¨ upper layer ä¿®æ”¹
   ```

2. **åœ¨ç›®å½•ä¸­åˆ›å»ºæ–°æ–‡ä»¶**:
   ```
   ç”¨æˆ·: touch /mnt/dir/new_file.txt
   â†’ ç›®å½• dir åœ¨ lower layerï¼ˆåªè¯»ï¼‰
   â†’ è§¦å‘ copy-up (å¤åˆ¶ç›®å½•ç»“æ„)
   â†’ åœ¨ upper layer åˆ›å»ºæ–‡ä»¶
   ```

### Copy-up éœ€è¦çš„ä¿¡æ¯

Copy-up è¿‡ç¨‹éœ€è¦ä» lower layer è·å–**å®Œæ•´çš„æ–‡ä»¶å…ƒæ•°æ®**ï¼š

```rust
struct stat64 {
    st_ino: u64,      // inode å·
    st_mode: u32,     // æ–‡ä»¶ç±»å‹å’Œæƒé™ â† å¿…é¡»ï¼
    st_uid: u32,      // æ‰€æœ‰è€… UID â† å¿…é¡»ï¼
    st_gid: u32,      // æ‰€æœ‰è€… GID â† å¿…é¡»ï¼
    st_size: i64,     // æ–‡ä»¶å¤§å° â† å¿…é¡»ï¼
    st_atime: i64,    // è®¿é—®æ—¶é—´
    st_mtime: i64,    // ä¿®æ”¹æ—¶é—´
    st_ctime: i64,    // çŠ¶æ€æ”¹å˜æ—¶é—´
    // ... å…¶ä»–å­—æ®µ
}
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›ä¿¡æ¯ï¼Ÿ**

1. **æƒé™ (mode)**: æ–°æ–‡ä»¶è¦ä¿æŒåŸæœ‰æƒé™
2. **æ‰€æœ‰è€… (uid/gid)**: æ–°æ–‡ä»¶è¦ä¿æŒåŸæœ‰æ‰€æœ‰è€…
3. **å¤§å° (size)**: éœ€è¦çŸ¥é“è¦å¤åˆ¶å¤šå°‘æ•°æ®
4. **æ—¶é—´æˆ³**: ä¿æŒæ–‡ä»¶çš„æ—¶é—´æˆ³ä¸å˜

### å¦‚ä½•è·å–è¿™äº›ä¿¡æ¯ï¼Ÿ

åœ¨ libfuse-fs ä¸­ï¼š

```
0.1.8 ç‰ˆæœ¬:
  lower_layer.do_getattr_helper(inode, None)
  â†’ è¿”å› stat64 ç»“æ„
  â†’ åŒ…å«æ‰€æœ‰éœ€è¦çš„å…ƒæ•°æ®

0.1.9 ç‰ˆæœ¬:
  lower_layer.getattr_with_mapping(inode, None, false)
  â†’ mapping=false è¡¨ç¤ºä¸è¿›è¡Œ UID/GID æ˜ å°„
  â†’ è¿”å›åŸå§‹çš„ stat64 ç»“æ„
  â†’ åŒ…å«æ‰€æœ‰éœ€è¦çš„å…ƒæ•°æ®
```

**å¦‚æœè¿™ä¸ªè°ƒç”¨å¤±è´¥ï¼ˆè¿”å› ENOSYSï¼‰**ï¼š

```
â†’ OverlayFS æ— æ³•è·å–æ–‡ä»¶å…ƒæ•°æ®
â†’ æ— æ³•çŸ¥é“æ–‡ä»¶çš„æƒé™ã€æ‰€æœ‰è€…ã€å¤§å°
â†’ æ— æ³•åˆ›å»ºæ­£ç¡®çš„å‰¯æœ¬
â†’ Copy-up å¤±è´¥
â†’ æ–‡ä»¶åˆ›å»º/ä¿®æ”¹å¤±è´¥
â†’ è¿”å›é”™è¯¯ç»™åº”ç”¨
```

## ğŸ§ª å®é™…éªŒè¯

### æµ‹è¯• 1: ç›´æ¥è§¦å‘ Copy-up

```bash
# åœ¨ Antares æŒ‚è½½ç‚¹
cd /mnt/antares

# å°è¯•ä¿®æ”¹åªè¯»å±‚çš„æ–‡ä»¶
echo "test" >> some_file_from_dicfuse.txt

# é¢„æœŸè¡Œä¸º:
# - å¦‚æœæœ‰ getattr å®ç° â†’ copy-up æˆåŠŸ â†’ æ–‡ä»¶ä¿®æ”¹æˆåŠŸ
# - å¦‚æœæ²¡æœ‰å®ç° â†’ copy-up å¤±è´¥ â†’ é”™è¯¯: Function not implemented
```

### æµ‹è¯• 2: Buck2 åœºæ™¯

```bash
# Buck2 åˆå§‹åŒ–
buck2 init

# Buck2 å†…éƒ¨ä¼š:
# 1. åˆ›å»º .buck-state/daemon-state.db
# 2. SQLite å¯ç”¨ WAL æ¨¡å¼
# 3. åˆ›å»º daemon-state.db-shm
# 4. è§¦å‘ copy-up
# 5. å¦‚æœ copy-up å¤±è´¥ â†’ xShmMap error
```

### æµ‹è¯• 3: ç›´æ¥æµ‹è¯• SQLite

```bash
# åœ¨æŒ‚è½½ç‚¹åˆ›å»ºæ•°æ®åº“
cd /mnt/antares
sqlite3 test.db "CREATE TABLE test (id INTEGER);"

# å¦‚æœçœ‹åˆ°:
# Error: I/O error within the xShmMap method
# â†’ è¯´æ˜ copy-up å¤±è´¥

# æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨
strace sqlite3 test.db "CREATE TABLE test (id INTEGER);" 2>&1 | grep -E "open|create|ENOSYS"
# å¯èƒ½çœ‹åˆ°:
# openat(..., "test.db-shm", ...) = -1 ENOSYS (Function not implemented)
```

## ğŸ“Š å®Œæ•´çš„é”™è¯¯ä¼ æ’­å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Buck2                                    â”‚
â”‚ é”™è¯¯: SQLite xShmMap I/O error          â”‚ â† ç”¨æˆ·çœ‹åˆ°çš„
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SQLite                                   â”‚
â”‚ xShmMap() è°ƒç”¨å¤±è´¥                       â”‚
â”‚ åŸå› : open() è¿”å›é”™è¯¯                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Linux Kernel (FUSE)                      â”‚
â”‚ æ–‡ä»¶åˆ›å»ºå¤±è´¥                             â”‚
â”‚ åŸå› : FUSE é©±åŠ¨è¿”å› ENOSYS æˆ– EIO       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OverlayFS (libfuse-fs)                   â”‚
â”‚ Copy-up å¤±è´¥                             â”‚
â”‚ åŸå› : æ— æ³•è·å– lower layer çš„æ–‡ä»¶å±æ€§   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dicfuse (lower layer)                    â”‚
â”‚ do_getattr_helper è¿”å› ENOSYS           â”‚ â† çœŸæ­£çš„æ ¹å› ï¼
â”‚ åŸå› : æ²¡æœ‰å®ç°è¿™ä¸ªæ–¹æ³•                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ… æ€»ç»“

### SQLite xShmMap é”™è¯¯å’Œ Copy-up çš„å…³ç³»

1. **SQLite éœ€è¦åˆ›å»ºå…±äº«å†…å­˜æ–‡ä»¶** (.db-shm)
2. **æ–‡ä»¶åˆ›å»ºè§¦å‘ OverlayFS çš„ copy-up**
3. **Copy-up éœ€è¦ä» lower layer è·å–å…ƒæ•°æ®**
4. **å¦‚æœè·å–å¤±è´¥ï¼ˆENOSYSï¼‰â†’ copy-up å¤±è´¥**
5. **æ–‡ä»¶åˆ›å»ºå¤±è´¥ â†’ xShmMap() å¤±è´¥**
6. **SQLite æŠ¥é”™ï¼šxShmMap I/O error**

### æ ¹æœ¬åŸå› 

ä¸æ˜¯ SQLite çš„é—®é¢˜ï¼Œä¹Ÿä¸æ˜¯ xShmMap çš„é—®é¢˜ï¼Œè€Œæ˜¯ï¼š
- **Dicfuse æ²¡æœ‰å®ç° `do_getattr_helper` (0.1.8)**
- **å¯¼è‡´ OverlayFS copy-up å¤±è´¥**
- **è¿›è€Œå¯¼è‡´æ–‡ä»¶åˆ›å»ºå¤±è´¥**
- **æœ€ç»ˆè¡¨ç°ä¸º SQLite xShmMap é”™è¯¯**

### éªŒè¯æ–¹æ³•

```bash
# 1. åœ¨ 0.1.8 ä¸‹å®ç° do_getattr_helper
./scripts/implement_and_test_0.1.8.sh

# 2. å¦‚æœæ„å»ºæˆåŠŸ â†’ è¯´æ˜å®ç°æ˜¯æ­£ç¡®çš„
# 3. å¦‚æœæœ‰è¿™ä¸ªå®ç°ï¼Œcopy-up å°±ä¼šæˆåŠŸ
# 4. SQLite xShmMap é”™è¯¯å°±ä¸ä¼šå‡ºç°
```

---

**å…³é”®æ´å¯Ÿ**: è¡¨é¢çš„é”™è¯¯ä¿¡æ¯ï¼ˆxShmMapï¼‰å’ŒçœŸæ­£çš„æ ¹å› ï¼ˆgetattr æœªå®ç°ï¼‰ç›¸éš”äº†å¥½å‡ å±‚ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™ä¸ªé—®é¢˜éš¾ä»¥è¯Šæ–­ï¼

